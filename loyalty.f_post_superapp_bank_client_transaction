-- DROP FUNCTION loyalty.f_post_superapp_bank_client_transaction(varchar, varchar, timestamp, numeric, varchar, varchar, varchar, varchar, int2, varchar);

CREATE OR REPLACE FUNCTION loyalty.f_post_superapp_bank_client_transaction(in_refer character varying, in_iin character varying, in_tran_date timestamp without time zone, in_amount numeric, in_company_name character varying, in_company_product character varying, in_bank_product character varying, in_card_idn character varying, in_is_reverse smallint, in_param character varying)
 RETURNS TABLE(j json)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
var_cli_id integer;
var_cli_dep_id integer;
var_is_client integer;
var_total_sum numeric;
var_comment varchar;
var_phone varchar;
var_cashback_amount numeric;
var_percent integer;
var_apt_trn_id varchar;
var_apt_trn_id_rev varchar;
var_zapret varchar;
var_mcc varchar;
var_ban varchar;

begin
	

if in_company_name not in ( select company_code from loyalty.dict_loyalty_percents_2)
then
RETURN QUERY
select ('{"cashbackAmount": "0", "cashbackPercent": "0",  "comment": "Запрещенный продукт"}')::json;
end if;

select into var_zapret value from stage.s10_z039_taboo_mcc_prod
where type1 = 'PRODUCT' and value = in_bank_product;

select into var_mcc value from stage.s10_z039_taboo_mcc_prod
where type1 = 'MCC' and value = in_param::jsonb->>'MCC';

select into var_ban coalesce(var_zapret, var_mcc);

if var_ban is not null
then
RETURN QUERY
select ('{"cashbackAmount": "0", "cashbackPercent": "0",  "comment": "Запрещенный продукт"}')::json;
end if;


if in_refer is null and in_iin is not null and var_ban is null and in_is_reverse=0  then 
	
RETURN QUERY
select
 json_object('{ cashbackAmount, cashbackPercent, comment, dailyAvlCashback ,avlCashback}',foo4.arr) as ret_json	
 from(
select 
array[
(cashback_amount+add_cashback)::text,
cashback_percent::text,
cashback_message::text,
total_cashback_2::text,
total_cashback_3::text
] as arr
from(      
select 
apt_trn_id,
extime,
refer,
clicode,
amount,
case 
	when partner_name = 'KAZH' and daily_coef = 0 then 'Достигнут дневной лимит'
	when partner_name = 'KAZH' and daily_coef = 1 and total_cashback_2 <= pre_cashback_amount and total_cashback<=(limit_amount_f_month + limit_regressive_f_total)  then 'Кэшбек предрасчитан'
	when pre_cashback_amount <= limit_amount_f_trn
	and pre_cashback_amount <= ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	and total_cashback<(limit_amount_f_month + limit_regressive_f_total) 
	then 'Кэшбек предрасчитан' 
	when pre_cashback_amount > limit_amount_f_trn
	and limit_amount_f_trn<=((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	then 'Кэшбек предрасчитан' --'тразакционный лимит'
	when pre_cashback_amount >= limit_amount_f_trn
	and limit_amount_f_trn >((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	then 'Кэшбек предрасчитан' --'остаток'
	when /*hotfix ticket 422106*/ pre_cashback_amount > 0 and pre_cashback_amount <= limit_amount_f_trn
	and limit_amount_f_trn >((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	then 'Кэшбек предрасчитан' --'остаток'
	when total_cashback>=(limit_amount_f_month + limit_regressive_f_total) 
	then 'Достигнут лимит' --'тразакционный лимит'
else 'Ошибка'
end as cashback_message,
case 
	when eco_card is not null then 
			case 
				when pre_cashback_amount + total_cashback <= limit_amount_f_month 
					then least(pre_cashback_amount, limit_amount_f_trn)
				else limit_amount_f_month - total_cashback
			end
	when partner_name = 'KAZH' and daily_coef = 0 then 0
	when partner_name = 'KAZH' and daily_coef = 1 and total_cashback_2 <= pre_cashback_amount and total_cashback<=(limit_amount_f_month + limit_regressive_f_total)  
	then total_cashback_2
	when pre_cashback_amount <= limit_amount_f_trn
	and pre_cashback_amount <= ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	and total_cashback<(limit_amount_f_month + limit_regressive_f_total) 
	then pre_cashback_amount
	when pre_cashback_amount > limit_amount_f_trn
	and limit_amount_f_trn<=((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	then limit_amount_f_trn
	when pre_cashback_amount >= limit_amount_f_trn
	and limit_amount_f_trn >((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	then ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	/*hotfix ticket 422106*/when pre_cashback_amount > 0 and pre_cashback_amount <= limit_amount_f_trn
	and limit_amount_f_trn >((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	then ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
	when total_cashback>=(limit_amount_f_month + limit_regressive_f_total) 
	then 0
else 0
end as cashback_amount,
case 
	when total_cashback < limit_amount_f_month 
then
(total_indicators_percent+coalesce(loyalty_percent,0)+add_prc/*delete insur+coalesce(insur.cashback_percent,0)*/) 
	when total_cashback >= limit_amount_f_month and  total_cashback < (limit_amount_f_month + limit_regressive_f_total)
then regressive_percent
	when total_cashback >= (limit_amount_f_month + limit_regressive_f_total)
then 0
end as cashback_percent,
partner_name,
is_return,
product_name,
'SUPER_APP' as user_channel,
case when total_cashback>=(limit_amount_f_month + limit_regressive_f_total) 
then 0
else total_cashback_2
end as total_cashback_2,
case when total_cashback>=(limit_amount_f_month + limit_regressive_f_total) 
then 0
else total_cashback_3
end as total_cashback_3,
add_cashback,
add_prc
from (
select
apt_trn_id,
foo.extime,
foo.refer,
clicode,
foo.amount,
foo.limit_amount_f_month,
foo.limit_regressive_f_total,
foo.total_cashback,
foo.total_cashback_2,
foo.total_cashback_3,
foo.total_indicators_percent,
foo.loyalty_percent,
foo.regressive_percent,
foo.eco_card,
case 
	when foo.total_cashback < foo.limit_amount_f_month
then
	daily_coef*(foo.amount * ((total_indicators_percent+coalesce(foo.loyalty_percent,0)/*delete insur+coalesce(insur.cashback_percent,0)*/)::decimal(19,2)/100))::decimal(19,2) 
	when foo.eco_card is not null 
then 0
	when foo.total_cashback >= foo.limit_amount_f_month and  foo.total_cashback < (foo.limit_amount_f_month + foo.limit_regressive_f_total)
then
	daily_coef*(foo.amount * ((foo.regressive_percent)::decimal(19,2)/100))::decimal(19,2)
 when foo.total_cashback >= (foo.limit_amount_f_month + foo.limit_regressive_f_total)
 then 0
end as pre_cashback_amount,
(total_indicators_percent+coalesce(foo.loyalty_percent,0)) as cashback_percent,
foo.partner_name as partner_name,
0 as is_return,
foo.limit_amount_f_trn,
foo.product_name,
foo.daily_coef,
add_cashback,
add_prc
 from (
			select 
			trn.refer as apt_trn_id,
			mtrx.cli_code as clicode,
			trn.amount,
			eco.value eco_card,
			case 
				when trn.partner_name = 'KAZH' or eco.value is not null then 0 else (mtrx.guaranteed_percent + mtrx.transaction_percent) 
			end as total_indicators_percent,
	         trn.trn_date as extime,
	         trn.refer,
	         case
				 when eco.value is not null then eco.eco_limit_trn
		         when spec_lim.spec_trn_limit is not null then spec_lim.spec_trn_limit
				 else  lim.limit_amount_f_trn 
	        end as limit_amount_f_trn,
	         case when trn.partner_name = 'KAZH' then 0 else lim.regressive_percent end as regressive_percent,
	         /*case
		         when spec_lim.spec_month_limit is not null then spec_lim.spec_month_limit
	        else lim.limit_amount_f_month end as limit_amount_f_month,*/
   				case
				      when eco.value is not null then eco.eco_limit_month
			          when trn.partner_name = 'KAZH' then spec_lim.spec_month_limit
		        else lim.limit_amount_f_month end as limit_amount_f_month,
	         case when trn.partner_name = 'KAZH' then 0 else lim.limit_regressive_f_total
	        end as limit_regressive_f_total,
	         trn.partner_name,
	         trn.product_name,
			case when eco.value is not null then eco.eco_percent 
	        when trn.product_name = 'TOURS' then lp.loyalty_percent_is_superapp
			else  (lp.loyalty_percent+lp.loyalty_percent_is_superapp) end as loyalty_percent,
			case when trn.product_name = 'TOURS' then lp.loyalty_percent else 0 end as add_prc,
	       case 
			when eco.value is not null then --eco
				coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = mtrx.cli_code
		         and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0)
			 when trn.partner_name = 'KAZH' then 
	         coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
	         where 1=1 /*tran_datetime::date >= date_trunc('month',current_date)::date
	         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
	         and cli_code = mtrx.cli_code
	         and channel_type = 'KAZH'
	         and coalesce(row_status,'A')!='D'
	         ),0) 
	         else
	           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
	         where tran_datetime::date >= date_trunc('month',current_date)::date
	         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
	         and cli_code = mtrx.cli_code
	         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
	         and coalesce(row_status,'A')!='D'
	         ),0) 
	         end as total_cashback, /*full month limit*/
	         	case when trn.partner_name = 'KAZH' then 
		         coalesce((select spec_trn_limit - total_cashback from(
		         select coalesce(sum(cashback_amount),0) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date = current_date
		         /*and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = mtrx.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
				else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = mtrx.cli_code
		         and channel_type not in  ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback_2,
		         /*AVL*/
		         case when trn.partner_name = 'KAZH' then 
		         coalesce((select spec_month_limit - total_cashback from(
		         select coalesce(sum(cashback_amount),0) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where 1=1--tran_datetime::date = current_date
		         /*and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = mtrx.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		          null
		         end as total_cashback_3,
		         /*AVL*/
		         /*daily limit*/
		    case when trn.partner_name = 'KAZH' then 
		              (select case 
		         when coalesce(sum(cashback_amount),0) = 1000  then 0
	         else 1
	         end as coef 
	         from loyalty.llt_frhc_bank_client_transactions_final
	         		where 1=1 
	         		and tran_datetime::date = current_date
	         		and cli_code = mtrx.cli_code
	         		and channel_type = 'KAZH'
	         		and coalesce(row_status,'A')!='D')
		         else
		         1
		         end as daily_coef,
		         /*daily limit*/
	(select
	loyalty.f_post_superapp_aviata_transaction(in_refer,
	in_iin,
	in_tran_date,
	in_amount,
	in_company_name,
	in_company_product,
	in_is_reverse, null, null)) as add_cashback
	         from 
	         (select in_refer as refer, in_iin as iin, in_tran_date as trn_date, in_amount as amount, in_company_name as partner_name, in_company_product as product_name, in_bank_product as card_product) trn
	       left join stage.loyalty_indicators mtrx
	        on trn.iin = mtrx.iin
	         and mtrx.report_date = (select max(report_date) from stage.loyalty_indicators where iin = trn.iin)--(date_trunc('month',current_date) - interval '1 day')::date
	        left join loyalty.llt_frhc_bank_client_cashback_limits lim
	        on mtrx.loyalty_category = lim.limit_type
	         left join loyalty.dict_loyalty_percents_2 lp
	         on trn.partner_name = lp.company_code
	         and trn.product_name = lp.product_name
	         --and lp.company_code not in ('MOBILE', 'INSURANCE')
	         left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name = trn.product_name
			and spec_lim.partner_name not in ('TOURS', 'DRIVE')
			 left join stage.dict_araldy_eco_products eco
			 on eco.value = trn.card_product
	         where 1=1
	         )foo 
	           /*left join stage.partners_terminal_fin terms
	        on terms.terminal_id = foo.term_id*/
	         /*left join loyalty.dict_loyalty_percents lp
	         on terms.partner_name = lp.company_code
	         and lp.company_code not in ('MOBILE', 'INSURANCE')*/
	         )foo2 )foo3 )foo4;

	        
elsif in_refer is not null and in_iin is not null and var_ban is null and in_is_reverse=0 then 


/*retry*/
	select into var_apt_trn_id apt_trn_id
	 from loyalty.llt_frhc_bank_client_transactions_final 
	         where apt_trn_id = in_refer
	         and is_return = 0
	         and tran_datetime::date >= current_date - 7;
/*retry*/
	
if var_apt_trn_id is not null then 
	RETURN QUERY
	select
	 json_object('{refer, cashbackAmount, cashbackPercent, comment, dailyAvlCashback, avlCashback}',foo2.arr) as ret_json
	 from(
	select array[
	refer::text,
	cashback_amount::text,
	cashback_percent::text,
	'Кэшбек начислен'::text,
	total_cashback_2::text,
	total_cashback::text
	] as arr
	from(
	select
	refer,
	cashback_amount,
	cashback_percent,
	case 
			when trn.channel_type = 'ECO_CARD' then 
				 coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
				 and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
			when trn.channel_type = 'KAZH' then 
		         coalesce((select spec_month_limit - total_cashback from(
		         select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where 1=1 /*tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = trn.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback,
		         	case when in_company_name = 'KAZH' then 
		         coalesce((select spec_trn_limit - total_cashback from(
		         select coalesce(sum(cashback_amount),0) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date = current_date
		         /*and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = trn.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		        null
		         end as total_cashback_2
	from loyalty.llt_frhc_bank_client_transactions_final trn
	where refer = in_refer
	and is_return = 0
	and tran_datetime::date >= in_tran_date::date
	)f
	) foo2;
end if;	   

if var_apt_trn_id is null then 

	INSERT INTO loyalty.llt_frhc_bank_client_transactions_final
	(apt_trn_id, tran_datetime, refer, cli_code, amount, cashback_amount, cashback_percent, channel_type, is_return, product_name,user_channel)        
select 
	apt_trn_id,
	extime,
	refer,
	clicode,
	amount,
cashback_amount+add_cashback,
cashback_percent,
	partner_name,
	is_return,
	product_name,
user_channel
from
(	
select 
	apt_trn_id,
	extime,
	refer,
	clicode,
	amount,
	case 
		when eco_card is not null and pre_cashback_amount > 0 then 
			case 
				when pre_cashback_amount + total_cashback <= limit_amount_f_month 
					then least(pre_cashback_amount, limit_amount_f_trn)
				else limit_amount_f_month - total_cashback
			end
		when partner_name = 'KAZH' and daily_coef = 0 then 0
		when partner_name = 'KAZH' and daily_coef = 1 and total_cashback_2 <= pre_cashback_amount and total_cashback<=(limit_amount_f_month + limit_regressive_f_total)  then total_cashback_2
		when pre_cashback_amount <= limit_amount_f_trn
		and pre_cashback_amount <= ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
		and total_cashback<(limit_amount_f_month + limit_regressive_f_total) 
		then pre_cashback_amount
		when pre_cashback_amount > limit_amount_f_trn
		and limit_amount_f_trn<=((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
		then limit_amount_f_trn
		when pre_cashback_amount >= limit_amount_f_trn
		and limit_amount_f_trn >((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
		then ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
		when /*hotfix ticket 422106*/ pre_cashback_amount > 0 and pre_cashback_amount <= limit_amount_f_trn
		and limit_amount_f_trn >((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
		then ((limit_amount_f_month + limit_regressive_f_total) - total_cashback)
		when total_cashback>=(limit_amount_f_month + limit_regressive_f_total) 
		then 0
	else 0
	end as cashback_amount,
	case 
		when total_cashback < limit_amount_f_month 
	then
	(total_indicators_percent+coalesce(loyalty_percent,0)+add_prc/*delete insur+coalesce(insur.cashback_percent,0)*/) 
		when eco_card is not null then 0
		when total_cashback >= limit_amount_f_month and  total_cashback < (limit_amount_f_month + limit_regressive_f_total)
	then regressive_percent
		when total_cashback >= (limit_amount_f_month + limit_regressive_f_total)
	then 0
	end as cashback_percent,
	case 
		when eco_card is not null then 'ECO_CARD' 
		else partner_name
	end partner_name,
	is_return,
	product_name,
	'SUPER_APP' as user_channel,
add_cashback
	from (
	select
	apt_trn_id,
	foo.extime,
	foo.refer,
	clicode,
	foo.amount,
	foo.limit_amount_f_month,
	foo.limit_regressive_f_total,
	foo.total_cashback,
	foo.total_indicators_percent,
	foo.loyalty_percent,
	foo.regressive_percent,
	foo.eco_card,
	case 
	when foo.total_cashback < foo.limit_amount_f_month 
	then
		daily_coef*(foo.amount * ((total_indicators_percent+coalesce(foo.loyalty_percent,0)/*delete insur+coalesce(insur.cashback_percent,0)*/)::decimal(19,2)/100))::decimal(19,2) 
		when foo.eco_card is not null then 0
		when foo.total_cashback >= foo.limit_amount_f_month and  foo.total_cashback < (foo.limit_amount_f_month + foo.limit_regressive_f_total)
	then
		daily_coef*(foo.amount * ((foo.regressive_percent)::decimal(19,2)/100))::decimal(19,2)
	 when foo.total_cashback >= (foo.limit_amount_f_month + foo.limit_regressive_f_total)
	 then 0
	end as pre_cashback_amount,
	(total_indicators_percent+coalesce(foo.loyalty_percent,0)+add_prc) as cashback_percent,
	foo.partner_name as partner_name,
	0 as is_return,
	foo.limit_amount_f_trn,
	foo.product_name,
	foo.daily_coef,
	case when total_cashback>=(limit_amount_f_month + limit_regressive_f_total) 
then 0
else total_cashback_2
end as total_cashback_2,
add_cashback,
add_prc
	 from (
				select 
				trn.refer as apt_trn_id,
				mtrx.cli_code as clicode,
				trn.amount,
				eco.value eco_card,
				case 
					when trn.partner_name = 'KAZH' or eco.value is not null then 0 else (mtrx.guaranteed_percent + mtrx.transaction_percent) 
				end as total_indicators_percent,
		         trn.trn_date as extime,
		         trn.refer,
		         case
					 when eco.value is not null then eco.eco_limit_trn
			         when spec_lim.spec_trn_limit is not null then spec_lim.spec_trn_limit
		        	else  lim.limit_amount_f_trn 
		        end as limit_amount_f_trn,
		         case when trn.partner_name = 'KAZH' then 0 else lim.regressive_percent end as regressive_percent,
		         /*case
			         when spec_lim.spec_trn_limit is not null then spec_lim.spec_month_limit
		        else lim.limit_amount_f_month end as limit_amount_f_month,*/
   				case
					 when eco.value is not null then eco.eco_limit_month
			         when  trn.partner_name = 'KAZH' then spec_lim.spec_month_limit
		        else lim.limit_amount_f_month end as limit_amount_f_month,
		         case when trn.partner_name = 'KAZH' then 0 else lim.limit_regressive_f_total
		        end as limit_regressive_f_total,
		         trn.partner_name,
		         trn.product_name,
		        case when eco.value is not null then eco.eco_percent 
				when trn.product_name = 'TOURS' then lp.loyalty_percent_is_superapp
	        	else  (lp.loyalty_percent+lp.loyalty_percent_is_superapp) end as loyalty_percent,
				case when trn.product_name = 'TOURS' then lp.loyalty_percent else 0 end as add_prc,
		         case 
				 when eco.value is not null then --eco
				 coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = mtrx.cli_code
		         and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0)
				 when trn.partner_name = 'KAZH' then 
		         coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where 1=1 /*tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = mtrx.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = mtrx.cli_code
		         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback,
		         case when eco.value is not null then --eco
				 coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = mtrx.cli_code
		         and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0)
				 when trn.partner_name = 'KAZH' then 
		         coalesce((select spec_trn_limit - total_cashback from(
		         select coalesce(sum(cashback_amount),0) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date = current_date
		         /*and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = mtrx.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = mtrx.cli_code
		         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback_2,
		         /*daily limit*/
		    case when trn.partner_name = 'KAZH' then 
		              (select case 
		         when coalesce(sum(cashback_amount),0) = 1000  then 0
	         else 1
	         end as coef 
	         from loyalty.llt_frhc_bank_client_transactions_final
	         		where 1=1 
	         		and tran_datetime::date = current_date
	         		and cli_code = mtrx.cli_code
	         		and channel_type = 'KAZH'
	         		and coalesce(row_status,'A')!='D')
		         else
		         1
		         end as daily_coef,
		         /*daily limit*/
	(select
	loyalty.f_post_superapp_aviata_transaction(in_refer,
	in_iin,
	in_tran_date,
	in_amount,
	in_company_name,
	in_company_product,
	in_is_reverse, null, null)) as add_cashback
		         from 
		         (select in_refer as refer, in_iin as iin, in_tran_date as trn_date, in_amount as amount, in_company_name as partner_name, in_company_product as product_name, in_bank_product as card_product) trn
		       left join stage.loyalty_indicators mtrx
		        on trn.iin = mtrx.iin
		         and mtrx.report_date = (select max(report_date) from stage.loyalty_indicators where iin = trn.iin)--(date_trunc('month',current_date) - interval '1 day')::date
		        left join loyalty.llt_frhc_bank_client_cashback_limits lim
		        on mtrx.loyalty_category = lim.limit_type
		         left join loyalty.dict_loyalty_percents_2 lp
		         on trn.partner_name = lp.company_code
		         and trn.product_name = lp.product_name
		         --and lp.company_code not in ('MOBILE', 'INSURANCE')
		         left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
		          on spec_lim.partner_name = trn.product_name
			and spec_lim.partner_name not in ('TOURS', 'DRIVE')
				left join stage.dict_araldy_eco_products eco
			 	on eco.value = trn.card_product
		         where 1=1
		         )foo 
		           /*left join stage.partners_terminal_fin terms
		        on terms.terminal_id = foo.term_id*/
		         /*left join loyalty.dict_loyalty_percents lp
		         on terms.partner_name = lp.company_code
		         and lp.company_code not in ('MOBILE', 'INSURANCE')*/
		         )foo2)foo3 ;
	
	RETURN QUERY
	select
	 json_object('{refer, cashbackAmount, cashbackPercent, comment, dailyAvlCashback, avlCashback}',foo2.arr) as ret_json
	 from(
	select array[
	refer::text,
	cashback_amount::text,
	cashback_percent::text,
	'Кэшбек начислен'::text,
	total_cashback_2::text,
	total_cashback::text
	] as arr
	from(
	select
	refer,
	cashback_amount,
	cashback_percent,
		case 
			when trn.channel_type = 'ECO_CARD' then 
				 coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
			when trn.channel_type = 'KAZH' then 
		         coalesce((select spec_month_limit - total_cashback from(
		         select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where 1=1 /*tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = trn.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback,
		         		         	case when in_company_name = 'KAZH' then 
		         coalesce((select spec_trn_limit - total_cashback from(
		         select coalesce(sum(cashback_amount),0) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date = current_date
		         /*and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = trn.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		        null
		         end as total_cashback_2
	from loyalty.llt_frhc_bank_client_transactions_final trn
	where refer = in_refer
	and tran_datetime::date >= in_tran_date::date
	)f
	) foo2; 
end if;

/*REVERSE*/
elsif in_refer is not null and in_iin is not null and var_ban is null and in_is_reverse=1 then 

/*retry*/
	select into var_apt_trn_id_rev apt_trn_id
	 from loyalty.llt_frhc_bank_client_transactions_final 
	         where apt_trn_id = in_refer
	         and is_return = 1
	         and tran_datetime::date >= current_date - 7;
/*retry*/
	
if var_apt_trn_id_rev is not null then 

	RETURN QUERY
		select
		 json_object('{refer, cashbackAmount, cashbackPercent, comment, avlCashback}',foo2.arr) as ret_json
		 from(
		select array[
		refer::text,
		cashback_amount::text,
		cashback_percent::text,
	'Кэшбек начислен'::text,
	total_cashback_2::text,
	total_cashback::text
		] as arr
		from(
		select 
		refer,
		cashback_amount,
		cashback_percent,
				case 
				 when trn.channel_type = 'ECO_CARD' then 
				 coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
				 when trn.channel_type = 'KAZH' then 
		         coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where 1=1 /*tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = trn.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback,
		         	case when trn.partner_name = 'KAZH' then 
		         coalesce((select spec_trn_limit - total_cashback from(
		         select coalesce(sum(cashback_amount),0) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date = current_date
		         /*and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = mtrx.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         )f
		          left join loyalty.llt_frhc_bank_partners_client_cashback_limits spec_lim 
	         on spec_lim.partner_name =  'KAZH'),0) 
		         else
		        null
		         end as total_cashback_2
		from loyalty.llt_frhc_bank_client_transactions_final trn
		where refer = in_refer
		and is_return = 1
		and tran_datetime::date >= in_tran_date::date
		)f
		) foo2;
end if;	   

if var_apt_trn_id_rev is null then 
	
	insert into loyalty.llt_frhc_bank_client_transactions_final
	(apt_trn_id, tran_datetime, refer, cli_code, amount, cashback_amount, cashback_percent, channel_type, is_return, product_name,user_channel) 	        	        
	select 
		apt_trn_id,
		tran_datetime,
		refer,
		cli_code,
		in_amount,
		case 
			when amount = in_amount then (-1)*cashback_amount 
			when amount > in_amount  then ((in_amount::numeric(19,2)/amount::numeric(19,2))::numeric(19,2))*(-1)*cashback_amount
			when amount < in_amount then (-1)*cashback_amount 
		end as cashback_amount,
		(in_amount::numeric(19,2)/amount::numeric(19,2))::numeric(19,2)*100 as cashback_percent,
		channel_type,
		1,
		product_name,
		user_channel
	from
		loyalty.llt_frhc_bank_client_transactions_final trn
	where apt_trn_id = in_refer
		and is_return = 0
		and user_channel = 'SUPER_APP';
	
	RETURN QUERY
	select
	 json_object('{refer, cashbackAmount, cashbackPercent, comment, avlCashback}',foo2.arr) as ret_json
	 from(
	select array[
	refer::text,
	cashback_amount::text,
	cashback_percent::text,
	'Кэшбек отменен'::text,
	total_cashback::text
	] as arr
			from(
		select 
		refer,
		cashback_amount,
		cashback_percent,
				case 
			     when trn.channel_type = 'ECO_CARD' then 
				 coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type = 'ECO_CARD'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
				 when trn.channel_type = 'KAZH' then 
		         coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where 1=1 /*tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date*/
		         and cli_code = trn.cli_code
		         and channel_type = 'KAZH'
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         else
		           coalesce( (select sum(cashback_amount) as total_cashback from loyalty.llt_frhc_bank_client_transactions_final
		         where tran_datetime::date >= date_trunc('month',current_date)::date
		         and tran_datetime::date < (date_trunc('month',current_date) + interval '1 month')::date
		         and cli_code = trn.cli_code
		         and channel_type not in ('MCC_ZAPRET', 'ECO_CARD', 'PRODUCT_ZAPRET')
		         and coalesce(row_status,'A')!='D'
		         ),0) 
		         end as total_cashback
	from loyalty.llt_frhc_bank_client_transactions_final trn
	where refer = in_refer
	and tran_datetime::date >= in_tran_date::date
	)f
	) foo2; 

end if;

end if;--global
	
end;
$function$
;
